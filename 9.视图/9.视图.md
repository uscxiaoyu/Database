# 视图

```sql
USE purchase;
SET SQL_SAFE_UPDATES=0;
```

## 一、 创建视图

- **视图**是由一个或多个表（视图）导出来的虚拟表，其结构和数据都依赖于基本表。

- 通过视图不仅可查看基本表中的记录，也可查询、修改和删除基本表中的数据。

- 为什么需要使用视图？
>- 简化查询
>- 安全性
>- 逻辑数据独立性

- 创建语法格式：

```sql
CREATE [OR REPLACE] [ALGORITHM = {UNDEFINED | MERGE | TEMPTABLE}] VIEW view_name [(column_list)]
AS 
SELECT查询语句
[WITH [CASCADE | LOCAL | CHECK OPTION] ];
```

> `CREATE`：表示创建视图的关键字。
> `OR REPLACE`：表示该语句能够替换已有视图。
> `ALGORITHM`：可选，表示视图选择的算法。
> `UNDEFINED`：表示MySQL将自动选择所要使用的算法。
>  `MERGE`：使得视图定义的某一部分取代语句的对应部分。
    `TEMPTABLE`：表示将视图的结果存入临时表，然后使用临时表执行语句。
    `view_name`：表示要创建的视图名称。
    `column_list`：可选，表示属性清单。
    `AS`：表示指定视图要执行的操作。
    `SELECT_statement`：表示从某个表或视图中查出满足条件的记录，并导入视图中。
    `WITH CHECK OPTION`：可选，表示创建视图时要保证在该视图的权限范围之内。
    `CASCADED`：需要满足跟该视图有关的所有相关视图和表的条件，该参数为默认值。
    `LOCAL`：可选。表示创建视图时，只要满足该视图本身定义的条件即可。


### 1. 使用表中所有的字段创建简单视图

#### 示例1: 创建视图`view_product`

```sql
CREATE VIEW view_product
AS
SELECT * FROM product;

show tables;

-- 查看视图view_product的前10条记录
SELECT * FROM view_product LIMIT 10;
```

### 2. 查看视图结构和定义

- `DESC[RIBE] view_name` 可查看视图的结构

#### 示例2：使用`DESC[RIBE]`查看视图`view_product`的结构

```sql
DESC view_product;
```

- `SHOW CREATE TABLE` 可查看视图的`DDL`

#### 示例3: 使用`SHOW CREATE VIEW | TABLE`查看`view_product`的定义

```sql
SHOW CREATE VIEW view_product;
```

### 3. 指定表中的某些字段构建视图

#### 示例4：创建视图`view_product2`，包含`product`表中的`product_id, product_name, product_place, subsort_id`。

```sql
CREATE VIEW view_product2
AS
SELECT product_id, product_name, product_place, subsort_id FROM product;

SELECT * FROM view_product2 LIMIT 10;
```

### 4. 基于分组查询（`GROUP BY`）构建汇总视图

#### 示例5：创建视图`sum_product`，包含`product`中`product_place`和各产地对应的产品数

```sql
CREATE VIEW sum_product
AS
SELECT product_place, COUNT(product_id) FROM product GROUP BY product_place;

desc sum_product;

SELECT * FROM sum_product;

-- 或则

SELECT sort_name, `COUNT(product_id)` FROM sum_product;

```

### 5. 基于多表查询建立视图

#### 示例6：创建视图`view_sort_product`，包含类别名称和对应的产品数量

```sql
CREATE VIEW view_sort_product
AS
SELECT sort.sort_name, COUNT(product.product_id)
FROM product JOIN sort ON product.sort_id = sort.sort_id
GROUP BY sort.sort_name;

SELECT * FROM view_sort_product;
```

### 6. 在视图中重命名表中的字段

如果未对视图中的字段进行重命名，则默认使用查询语句中的字段名称

#### 示例7: 创建视图`sum_product`，包含`product`中的`product_place`，各产地对应的产品数量，并命名为`num_product`

```sql
CREATE VIEW sum_product2(product_place, num_product)
AS
SELECT product_place, COUNT(product_id) FROM product GROUP BY product_place;

desc sum_product2;

-- 或者
CREATE VIEW sum_product3
AS
SELECT product_place, COUNT(product_id) AS num_product
FROM product GROUP BY product_place;

desc sum_product3;

SELECT * FROM sum_product3;
```

## 二、查询视图

视图具有与表相同的查询语法:

```sql
SELECT * | 视图字段列表
FROM 视图名称
WHERE 条件表达式;
```
> 等价于在AS后查询结构的基础上再进行筛选

#### 示例7: 查看视图`sum_product3`中的所有记录

```sql
SELECT *
FROM sum_product3;

-- 等价于查看
SELECT *
FROM (SELECT product_place, COUNT(product_id) AS num_product
FROM product GROUP BY product_place) AS a;
```

### 练习1

(1) 创建`view_member`视图, 包含`member`表中的`user_name, sex, email`等字段

```sql
CREATE VIEW view_member
AS
SELECT user_name, sex, email
FROM member;
```

(2) 利用`DESC`查看`view_member`的结构

```sql
DESC view_member;
```

(3) 利用`SHOW CRAETE VIEW`查看`view_member`的定义

```sql
SHOW CREATE VIEW view_member;
```

(4) 创建`view_sort`视图，包含`sort`表中的`sort_name`， 以及其对应的子类别的数量，并命名为`num_subsort`

```sql
CREATE VIEW view_sort
AS
SELECT sort.sort_name, COUNT(subsort.subsort_id) AS num_subsort
FROM sort JOIN subsort ON sort.sort_id = subsort.sort_id
GROUP BY subsort.subsort_id;

-- 或
CREATE VIEW view_sort(sort_name,  num_subsort)
AS
SELECT sort.sort_name, COUNT(subsort.subsort_id) AS num_subsort
FROM sort JOIN subsort ON sort.sort_id = subsort.sort_id
GROUP BY sort.sort_name;
```

(5) 在`view_sort`视图查询类别名称中有'办公'两个字的所有记录

```sql
SELECT *
FROM view_sort
WHERE sort_name LIKE '%办公%';
```

## 三、修改(重新定义)视图结构

### 1. 利用`CREATE OR REPLACE VIEW`重新定义视图

#### 示例9：重新定义视图`view_product`，包含`product_id, product_name, product_place, sort_id, subsort_id`。

```sql
CREATE OR REPLACE VIEW view_product3
AS
SELECT product_id, product_name, product_place, sort_id, subsort_id
FROM product;

SHOW TABLES;
```

### 2. 使用`ALTER`语句修改视图

语法：

```sql
ALTER [ALGORITHM = {UNIDIFIED | MERGE | TEMPTABLE}]
VIEW view_name [(column_list)]
AS SELECT查询语句
[WITH [CASCADE | LOCAL] CHECK OPTION];

注意：被修改的视图必须要存在
```

#### 示例10: 修改视图结构`view_product`, 包含`product_id, product_name, product_place`

```sql
ALTER VIEW view_product
AS
SELECT product_id, product_name, product_place
FROM product;
```

### 四、通过视图操作基本表的记录

### 1. 更新 `UPDATE`

#### 示例11：通过`view_product`把`product_place`为'国产'的产品记录的对应值更改'国产'

```sql
UPDATE view_product
SET product_place = '中国'
WHERE product_place = '国产';

SELECT * FROM view_product WHERE product_place='中国' LIMIT 10;

SELECT * FROM product WHERE product_place='中国' LIMIT 10;
```

### 2. 插入 `INSERT`

#### 示例12：通过`view_product`插入一条`product_id = '12345', product_name='3d打印机', product_place='上海'`

```sql
INSERT INTO view_product(product_id, product_name, product_place)
VALUES ('12345', '3d打印机', '上海');

SELECT * FROM view_product WHERE product_name='3d打印机';

SELECT * FROM product WHERE product_name='3d打印机';
```

### 3. 删除 `DELETE`

#### 示例13：通过`view_product`删除`product_name`为'3d打印机'的记录

```sql
DELETE FROM view_product
WHERE product_name = '3d打印机';

SELECT * FROM view_product WHERE product_name='3d打印机';

SELECT product_id, product_name, product_place FROM product WHERE product_name='3d打印机';
```

>注意，当视图包含以下结构时，以下更新操作不能执行：
>（1）包含基本表中被定义为非空的列
>（2）select语句后的字段列表中使用了数学表达式
>（3）select语句后的字段列表中使用了聚合函数
>（4）select语句使用了DISTINCT, UNION, TOP, GROUP BY 或 HAVING子句

### 五、删除视图

语法:

```sql
DROP VIEW 视图名称;
```

#### 示例14: 删除视图`view_product`

```sql
DROP VIEW if exists view_product;

SHOW TABLES;
```

#### 练习2

(1) 利用`CREATE OR REPLACE VIEW`创建`view_member`视图, 包含`member`表中的`user_name, sex, email`等字段

```sql
CREATE OR REPLACE VIEW view_member
AS
SELECT user_name, sex, email
FROM member;
```

(2) 利用`ALTER VIEW`修改视图`view_member`，使其包含`member`表中的`user_name, sex, email, address, phone`等字段

```sql
ALTER VIEW view_member
AS
SELECT user_name, true_name, sex, email, address, phone
FROM member;
```

(3) 通过`view_memeber`更新`user_name`为'饿狼'的记录的`true_name`为'胡颖'

```sql
SELECT * FROM view_member WHERE user_name = '饿狼';

UPDATE view_member
SET true_name = '胡颖'
WHERE user_name = '饿狼';

SELECT * FROM view_member WHERE user_name = '饿狼';
SELECT * FROM member WHERE user_name = '饿狼';
```

(4) 通过`view_memeber`插入一条记录，`user_name`为'风清扬', `true_name`为'张三丰', `sex`为'女'

```sql
INSERT INTO view_member(user_name,true_name, sex)
VALUES ('风清扬', '张三丰', '女');

SELECT * FROM view_member WHERE user_name = '风清扬';
SELECT * FROM member WHERE user_name = '风清扬';
```

(5) 通过`view_memeber`删除`user_name`为'风清扬'的记录

```sql
DELETE FROM view_member
WHERE user_name = '风清扬';
```

(6) 删除视图`view_memeber`

```sql
DROP VIEW IF EXISTS view_member;
```
