[toc]

# 数据库权限和用户管理

对于任何一种数据库而言，安全性在实际应用中最重要。如果安全性得不到保证，那么数据库将面临各种各样的威胁，例如数据丢失，严重时会直接导致系统瘫痪。`MySQL`提供了完善的管理机制和操作手段。

## 一、访问控制和权限表

为满足`MySQL`服务器的安全基础，考虑以下内容：

- 多数用户只需要对表进行**读**和**写**，但少数用户需要能创建和删除表；

- 某些用户需要读表，但可能不需要更新表；

- 可能想允许用户**添加**数据，但不允许他们删除数据；

- 某些用户（管理员）可能需要处理用户账号的权限，但多数用户不需要；

- 可能想让用户通过**存储过程**访问数据，但不允许他们直接访问数据；

- 可能想根据用户**登录的地点ip**限制对某些功能的访问。

`MySQL`服务器通过`MySQL`权限来来控制用户对数据库的访问，安装`MySQL`数据库成功后，会自动安装多个数据库。`MySQL`**权限表**存放在名称为`MySQL`的数据库里。常用到的表有`user、db、table_priv、columns_priv、column_priv`和`procs_priv`。

### 1. `user`表

```mysql
DESC mysql.user;
```

`user`表是`mysql`中最终的一个**权限表**。可以使用`desc`语句来查看`user`的基本结构。`user`列主要分为4个部分：**用户列、权限列、安全列和资源控制列**。其中，用户列和权限列使用最为频繁。权限可以进一步分为：

- 普通权限：用于对数据库的操作。

- 管理权限：对数据库进行**管理**的操作。

当用户进行连接时，权限表的存取过程有以下两个阶段：

- 先从`user`表中的`host、user`和`password`这3个字段中判断连接的ip、用户名称和密码是否存在于表中，如果存在，则通过身份验证，否则拒绝连接。

- 如果通过身份验证，按照以下权限的顺序得到数据库权限：`user、db、table_priv、colums_priv`。

这几个表的权限依次递减，**全局权限覆盖局部权限**。

### 1.1 `user`表主要字段

```mysql
DESC mysql.user;
```

`user`表主要包含四类字段：

- 用户字段：`user`表中的`host、user`和`password`字段都属于用户字段。

- 权限字段：`user`表中包含几十个与权限有关以`priv`结尾的字段，这些权限字段决定了用户的权限，这些权限包括基本权限、修改和添加权限、关闭服务器权限、超级权限和加载权限等。

- 安全字段：安全列只有6个字段，2个是`ssl`相关的：`ssl_type`和`ssl_cipher`，2个是`x509相`关的：`x509_issuer`和`x509_subject`，另外2个是授权插件相关的。`ssl`用于**加密**；`x509`标准可用于**标识用户**；`plugin`字段标识可以用于**验证用户身份**的插件，如果该字段为空，服务器使用内建授权验证机制验证用户身份。

- 资源控制字段：资源控制列的字段用来**限制用户使用的资源**，这些字段的默认值为`0`，表示没有限制，包含4个字段：

  - `max_questions`：用户每小时允许执行的查询操作次数。
  - `max_updates`：用户每小时允许执行的更新操作次数。
  - `max_connections`：用户每小时允许执行的连接操作次数。
  - `max_user_connections`：单个用户可以同时具有的连接次数。

### 1.2 `db`表和`host`表

```mysql
DESC mysql.db;
DESC mysql.host;
```

`db`表和`host`表也是mysql数据库中非常重要的权限表。`db`表中存储了用户对某个数据库的操作权限，决定用户能从哪个主机存取哪个数据库；`host`表中存储了某个主机对数据库的操作权限，配合`db`权限表对给定主机上数据库级操作权限做更细致的控制。这两个权限表不受`grant`和`revoke`语句的影响。`db`表比较常用，`host`表一般很少使用。`db`表和`host`表结构相似，可以使用`desc`语句来查看这两个表的基本结构。

字段大致可以分为用户列和权限列：
- 用户列
	- `db`表的用户列有3个字段：`host、db`和`user`。这3个字段分别表示主机名、数据库名和用户名；`host`表的用户列有两个字段：`host`和`db`。这两个字段分别表示主机名和数据库名。
	- `host`表是`db`表的扩展。如果`db`表中找不到`host`字段的值，就需要到`host`表中去寻找。但是`host`表很少用到，通常`db`表的设置已经可以满足权限控制要求了。
- 权限列
	- `db`表和`host`表的权限列大致相同，表中`create_routine_priv`和`alter_routine_priv`这两个字段表明用户是否有创建和修改存储过程的权限。
	- `user`表中的权限是针对所有数据库的。如果`user`表中的`select_priv`字段取值为`y`，那么该用户可以查询所有数据库中的表；如果为某个用户只设置了查询`test`表的权限，那么`user`表的`select_priv`字段的取值为`n`。而这个`select`权限则记录在`db`表中。`db`表中`select_priv`字段的取值将会是y。由此可知，用户先根据`user`表的内容获取权限，然后再根据`db`表的内容获取权限。

### 1.3 `tables_priv`表

```mysql
DESC mysql.db;
DESC mysql.host;
```

`tables_priv`表可以对单个表进行权限设置 ,用来指定表级权限。这里指定的权限适用于一个表的所有列。用户可以用desc语句查看表结构。`tables_p`riv表有8个字段：`host、db、user、table_name、grantor、timestamp、table_priv和column_priv`。各个字段说明如下：

- `host、db、user`和`table_name`等4个字段分别表示主机名、数据库名、用户名和表名。
- `grantor`表示修改该记录的用户。
- `timestamp`字段表示修改该记录的时间。
- `table_priv`字段表示对表进行操作的权限，这些权限包括`select、insert、update、delete、create、drop、grant、references、index和alter`。
- `column_priv`字段表示对表中的列进行操作的权限，这些权限包括`select、insert、update和references`。

### 1.4 `columns_priv`表

```mysql
DESC columns_priv;
```

`columns_priv`表可以对表中的某一列进行权限设置。`columns_priv`表只有7个字段，分别是`host、db、user、table_name、column_name、timestamp`和`column_priv`。其中，`column_name`用来指定对哪些数据列具有操作权限。

`mysql`中权限的分配是按照`user`表、`db`表、`tables_priv`表和`columns_priv`表的顺序进行分配的。数据库系统中，先判断`user`表中的值是否为`y`，如果`user`表中的值是`y`，就不需要检查后面的表了；如果`user`表中的值为`n`，则依次检查`db`表、`tables_priv`表和`columns_priv`表。

### 1.5 `procs_priv`表

```mysql
DESC procs_priv;
```

`procs_priv`表可以对存储过程和存储函数进行权限设置。可以使用`desc`语句来查看`procs_priv`表的基本结构。`procs_priv`表包含8个字段：`host、db、user、routine_name、routine_type、grantor、proc_priv`和`timestamp`等。各个字段的说明如下：

- `host、db`和`user`字段分别表示主机名、数据库名和用户名。
- `routine_name`字段表示存储过程或存储函数的名称。
- `routine_type`字段表示存储过程或存储函数的类型。该字段有两个值，分别是`function`和`procedure`。`function`表示是一个存储函数；`procedure`表示是一个存储过程。
- `grantor`字段存储插入或修改该记录的用户。
- `proc_priv`字段表示拥有的权限，包括`execute、alter routine、grant`等3种。
- `timestamp`字段存储记录更新的时间。

## 二、用户管理

### 1. `MySQL`中的用户种类

`MySQL`大致将用户分为两类：

- 超级管理员用户：具有所有权限，如创建用户、删除用户、管理用户等
- 普通用户：只拥有被赋予的某些权限


