# 数据定义：表约束与索引
  
准备工作:
- 创建stu_info数据库和grade表
```sql {.line-numbers}
CREATE DATABASE stu_grade;
USE stu_grade;
CREATE TABLE grade(
    id int,
    name varchar(
    grade float
    );
```
- 创建purchase数据库和product表
```sql {.line-numbers}
CREATE DATABASE purchase;
USE purchase;
CREATE TABLE Product (Product_ID CHAR(10) COMMENT '商品编号',
                      Product_Name VARCHAR(100) COMMENT '商品名称',
                      Product_Code VARCHAR(10) COMMENT '商品编码',
                      Product_Place CHAR(50) COMMENT '产地',
                      Product_Date DATE COMMENT '生产日期',
                      Price FLOAT COMMENT '价格',
                      Unit VARCHAR(20) COMMENT '单位',
                      Detail VARCHAR(20) COMMENT '规格',
                      
                      SubSort_ID VARCHAR(10) COMMENT '子类别id',
                      Sort_ID VARCHAR(10) COMMENT '根类别id');
```

## 一、表约束
表的约束分为字段级别约束和表级别约束。常见的字段级别约束包括：非空约束(`NULL/NOT NULL`)、唯一约束(`UNIQUE)`、主键约束(`PRIMARY KEY`)、默认值(`DEFAULT`)、外键约束(`REFERENCES`)。其中，主键约束同时满足非空约束和唯一性约束。
### 1.单字段主键
单字段主键即在1个字段上构建的主键约束。
```sql
字段 数据类型(长度) PRIMARY KEY,
```
#### 示例1: 将数据表grade中id字段设置为主键。
```sql {.line-numbers}
USE stu_info;
ALTER TABLE grade MODIFY id int primary key;
DESC grade;
```
### 2.多字段主键
即在2个或多个字段上构建的主键约束。
```sql
PRIMARY KEY (字段1, 字段2, ....),
```
#### 示例2: 新建数据表example，并创建id字段，属性为INT(10)，并设置为主键。
```sql {.line-numbers}
CREATE TABLE example (id int(10) primary key);
CREATE TABLE example2 (id int(10),
                primary key (id));
DESC example;
```
#### 示例3: 新建数据表course，创建stu_id、course_id和grade三个字段，其中stu_id和course_id设置为多字段主键。
```sql {.line-numbers}
CREATE TABLE course (stu_id int,
                     course_id int,
                     grade float,
                     primary key (stu_id, course_id));
DESC course;
```
### 3.非空约束
设置非空约束的字段必须有值。
#### 示例4: 将grade表的username字段改为非空
```sql {.line-numbers}
ALTER TABLE grade MODIFY username VARCHAR(20) NOT NULL;
DESC grade;
```
### 4.唯一性约束
设置唯一性约束的字段的值不重复，即任意两行的该字段值不相同。
#### 示例5: 将数据表grade中username字段设置唯一性约束。
```sql {.line-numbers}
ALTER TABLE grade MODIFY username VARCHAR(20) UNIQUE;
DESC grade;
```

### 5.默认值
即如果没有该字段未设定值，则取默认值
#### 示例6：将数据表grade中grade字段设置默认约束值为0。
```sql {.line-numbers}
ALTER TABLE grade MODIFY grade FLOAT DEFAULT 0;
DESC grade;
```

### 6.自增auto_increment
#### 示例7：在数据表grade中id字段，设置为字段值自动增加。
```sql {.line-numbers}
ALTER TABLE grade modify id int auto_increment;
DESC grade;
```
### 练习3: 创建数据表的约束:  
| 字段          | 数据类型     | 约束      | 说明     |
| :------------ | :----------- | :-------- | :------- |
| Product_ID    | char(10)     | 主键      | 商品编号 |
| Product_Name  | varchar(100) | 唯一性    | 商品名称 |
| Product_Code  | varchar(10)  | 非空      | 商品编码 |
| Product_Place | char(10)     |           | 商品产地 |
| Place_Date    | date         |           | 生产日期 |
| Price         | float        | 默认值为0 | 商品价格 |
| Unit          | varchar(20)  |           | 单位     |
| Detail        | varchar(20)  |           | 规格     |
| SubSort_ID    | varchar(10)  | 非空      | 子类别ID |
| Sort_ID       | varchar(10)  | 非空      | 类别ID   |

```sql {.line-numbers}
ALTER TABLE product MODIFY Product_ID CHAR(5) PRIMARY KEY COMMENT '商品编号';
ALTER TABLE product MODIFY Product_Name VARCHAR(100) UNIQUE COMMENT '商品名称'; -- 有重复记录
ALTER TABLE product MODIFY Product_Code VARCHAR(10) NOT NULL COMMENT '商品号';
ALTER TABLE product MODIFY Price DECIMAL(10, 2) DEFAULT 0;
ALTER TABLE product MODIFY SubSort_ID CHAR(5) NOT NULL COMMENT '子类别ID';
ALTER TABLE product MODIFY Sort_ID CHAR(2) NOT NULL COMMENT '类别ID';

DESC product;
```

### 7.外键约束`foreign key`
建立外键约束语法:
- （1）通过`alter table`语法构建外键约束
```sql
ALTER TABLE 表名 ADD CONSTRAINT [外键名] FOREIGN KEY(外键字段名)
REFERENCES 外表表名(主键字段名);
```
> 注意：(1)建立外键的表必须是InnoDB型的表，不能是临时表。因为MySQL中只有InnoDB型的表才支持外键；
(2)定义外键名时，不能加引号。如：constraint 'FK_ID' 或 constraint " FK_ID "都是错误的；
(3)被参照表必须先于参照表定义，且被参照字段必须为被参照表的主键。

- （2）通过`create table`语法构建外键约束
```sql
CREATE TABLE [数据库名.]表名 (
    字段1 类型[(长度)] 其它列级约束,
    ...
    CONSTRAINT [约束名] FOREIGN KEY (参照字段) REFERENCES 被参照表(被参照表主键);
)
```
例如:

```sql
CREATE TABLE student(
    sid INT(4) NOT NULL PRIMARY KEY,
    sname VARCHAR(36),
    gid INT(4) NOT NULL,
    CONSTRAINT FOREIGN KEY (gid) REFERENCES grade(id));
```
#### 课堂示例8: 为product表的sort_id添加外键约束
```sql
USE purchase;

ALTER TABLE sort
MODIFY sort_id CHAR(2) PRIMARY KEY; -- 首先，被引用的主表字段应为主键，因此需为sort表的Sort_ID字段添加主键约束，否则建立外键时会提示1215错误

ALTER TABLE product
ADD CONSTRAINT fk_sortid FOREIGN KEY (sort_id) REFERENCES sort(sort_id); -- 然后，为表product的Sort_ID字段添加外键约束

SHOW CREATE TABLE product;  -- 使用show create table 来查看表的构建语句
```
建立外键的完整格式:
```sql
ALTER TABLE 表名 ADD CONSTRAINT [外键名] FOREIGN KEY(外键字段名) REFERENCES 外表表名(主键字段名)
[ON DELETE {CASCADE | SET NULL | NO ACTION | RESTRICT}]
[ON UPDATE {CASCADE | SET NULL | NO ACTION | RESTRICT}]

注意：（1）CASCADE: 主表中删除或更新对应的记录时，同时自动地删除或更新从表中匹配的记录。
(2) SET NULL: 主表中删除或更新被参照列记录时，同时将从表中的外键列设为空。
(3) NO ACTION: 拒绝删除或者更新主表被参照列记录，从表也不进行任何操作。
(4) RESTRICT: 拒绝删除或者更新主表被参照列记录。
```

删除外键约束:
```sql
ALTER TABLE 表名
DROP FOREIGN KEY 约束名称;
```

#### 课堂示例9：删除product表的sort_id上的外键约束
```sql {.line-numbers}
ALTER TABLE product
DROP FOREIGN KEY fk_sortid;

SHOW CREATE TABLE product;
```

#### 课堂练习4
(1) 为product表添加Sort_ID的外键约束FK_sortid1
```sql {.line-numbers}
ALTER TABLE product
ADD CONSTRAINT fk_sortid1 Foreign key (sort_id) references sort(sort_id)
ON UPDATE RESTRICT ON DELETE RESTRICT;
```
(2) 使用语句为subsort表的Sort_ID添加引用自sort表外键名为FK_sortid2的外键约束，并设置为on delete cascade参数。
```sql {.line-numbers}
ALTER TABLE subsort
ADD CONSTRAINT fk_sortid2 FOREIGN KEY (sort_id) REFERENCES sort(sort_id)
ON DELETE CASCADE;
```
(3) 为product表添加Subsot_id的引用自subsort表的外键约束FK_subsortid。（注意：主表被引用的列应具有主键约束或唯一性约束。）
```sql {.line-numbers}
ALTER TABLE subsort
MODIFY subsort_id CHAR(5) PRIMARY KEY;

-- 查看product表中subsort_id列是否有subsort表中subsort_id列未包含的值
SELECT DISTINCT subsort_id
FROM product
WHERE subsort_id NOT IN (SELECT DISTINCT subsort_id FROM subsort); 

-- 若product表中subsort_id列有subsort表中subsort_id列未包含的值，则进行以下操作
SET SQL_SAFE_UPDATES=0;

DELETE FROM product
WHERE subsort_id = 3317 OR subsort_id = 6412;  -- 删除对应记录

DELETE FROM product
WHERE subsort_id IS NULL;

-- 最后，才能建立外键联系
ALTER TABLE product
ADD CONSTRAINT fk_subsortid FOREIGN KEY (subsort_id) REFERENCES subsort(subsort_id)
ON DELETE CASCADE ON UPDATE CASCADE;
```
(4) 删除product表中的Subsort_ID的外键约束。
```sql {.line-numbers}
ALTER TABLE product
DROP FOREIGN KEY fk_subsortid;
```



## 二、创建索引

### 1. 创建表的时候创建索引。

#### 示例10：在`stu_info`数据库中创建`student`表及相关索引。
```sql {.line-numbers}
USE stu_info;
CREATE TABLE student(stu_id int(10),
                      name varchar(20),
                      course varchar(50),
                      score float,
                      DESCription varchar(100),
                      INDEX(stu_id),                           #创建普通索引
                      UNIQUE INDEX unique_id(stu_id ASC),      #创建唯一性索引
                      FULLTEXT INDEX fulltext_name(name),      #创建全文索引
                      INDEX single_course(course(50)),         #创建单列索引
                      INDEX multi(stu_id, name(20))            #创建多列索引
                      );
```
### 2. 利用`create index`在已有表上创建索引。
将索引视为独立的数据库对象。
#### 示例11：创建`book1`，然后利用`create index`创建索引。
```sql {.line-numbers}
CREATE TABLE book1(bookid int NOT NULL,
                   bookname varchar(255) NOT NULL,
                   authors varchar(255) NOT NULL,
                   info varchar(255) NOT NULL,
                   comment varchar(255) NOT NULL,
                   publicyear YEAR NOT NULL
                   );

CREATE INDEX index_id ON book1(bookid);                         #创建普通索引
CREATE UNIQUE INDEX uniqueidx ON book1(bookid);                 #创建唯一性索引
CREATE INDEX singleidx ON book1(comment);                       #创建单列索引
CREATE INDEX mulitidx ON book1(bookname(20), authors(20));      #创建多列索引
CREATE FULLTEXT INDEX fulltextidx ON book1(info);               #创建全文索引

DESC book1;
```
### 3. 利用`alter table`在已有表上创建索引。
将索引视为表的组成部分。
#### 示例12：使用ALTER TABLE语句在已经存在表上创建索引。
```sql {.line-numbers}
-- 先将数据表book1复制为book2表。注意book2只复制了book1的字段及类型。
CREATE TABLE book2 SELECT * FROM book1;

-- 添加索引
ALTER TABLE book2 ADD INDEX index_id(bookid);                   #创建普通索引
ALTER TABLE book2 ADD UNIQUE INDEX uniqueidx(bookid);           #创建唯一性索引
ALTER TABLE book2 ADD INDEX singleidx(comment(50));             #创建单列索引
ALTER TABLE book2 ADD INDEX mulitidx(bookname(20),authors(20)); #创建多列索引
ALTER TABLE book2 ADD FULLTEXT INDEX fulltextidx(info);         #创建全文索引

DROP INDEX uniqueidx ON book2;
```

#### 示例13：删除表book1中名称为fulltextidx的全文索引。
```sql
ALTER TABLE book1 drop index fulltextidx;
```
#### 示例14：删除表book1中名称为singleidx的单列索引。
```sql
drop index singleidx on book1;
```
#### 练习5
```sql {.line-numbers}
create unique index pcode_idx on product(Product_Code);
create index detail_idx on product(Detail);

create fulltext index pplace_fullidx on product(Product_Place);
show CREATE TABLE book2;
```
